<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-lang-key="title">آنالیز دانه‌بندی مصالح</title>
    <style>
        :root {
            --primary-bg-color: #2c3e50;
            --secondary-bg-color: #34495e;
            --header-bg-color: #1a252f;
            --text-color: #ecf0f1;
            --primary-accent-color: #e67e22;
            --secondary-accent-color: #f1c40f;
            --border-color: #4a627a;
            --input-bg-color: #2c3e50;
            --button-bg-color: #e67e22;
            --button-hover-bg-color: #d35400;
            --danger-color: #e74c3c;
        }
        body { font-family: 'Tahoma', sans-serif; background-color: var(--primary-bg-color); color: var(--text-color); margin: 0; padding: 20px; line-height: 1.6; }
        .container { max-width: 1200px; margin: 0 auto; background-color: var(--secondary-bg-color); padding: 20px; border-radius: 8px; box-shadow: 0 0 20px rgba(0, 0, 0, 0.5); }
        header { background-color: var(--header-bg-color); padding: 20px; border-radius: 8px 8px 0 0; display: flex; justify-content: space-between; align-items: center; border-bottom: 3px solid var(--primary-accent-color); }
        header h1 { margin: 0; font-size: 2em; color: var(--secondary-accent-color); }
        .toolbar button { margin-left: 10px; }
        button { background-color: var(--button-bg-color); color: white; border: none; padding: 10px 15px; border-radius: 5px; cursor: pointer; font-size: 1em; transition: background-color 0.3s; }
        button:hover { background-color: var(--button-hover-bg-color); }
        #add-row { background-color: #27ae60; }
        #add-row:hover { background-color: #229954; }
        #calculate { background-color: var(--secondary-accent-color); color: #2c3e50; font-weight: bold; }
        #calculate:hover { background-color: #e0b60b; }
        button.delete-row { background-color: var(--danger-color); }
        button.delete-row:hover { background-color: #c0392b; }
        main { padding-top: 20px; }
        section { margin-bottom: 30px; background: var(--primary-bg-color); padding: 20px; border-radius: 8px; border: 1px solid var(--border-color); }
        h2 { color: var(--secondary-accent-color); border-bottom: 2px solid var(--border-color); padding-bottom: 10px; margin-top: 0; }
        select, input[type="number"] { width: 100%; padding: 10px; margin-top: 10px; margin-bottom: 10px; border-radius: 5px; border: 1px solid var(--border-color); background-color: var(--input-bg-color); color: var(--text-color); font-size: 1em; }
        #sieve-table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        #sieve-table th, #sieve-table td { border: 1px solid var(--border-color); padding: 12px; text-align: center; }
        #sieve-table th { background-color: var(--header-bg-color); color: var(--secondary-accent-color); font-size: 1.1em; }
        #results-output p { font-size: 1.2em; background: var(--secondary-bg-color); padding: 10px; border-radius: 5px; border-left: 5px solid var(--primary-accent-color); }
        #results-output span { font-weight: bold; color: var(--secondary-accent-color); padding: 0 10px; }
        .chart-container { margin-top: 20px; padding: 15px; border: 1px solid var(--border-color); border-radius: 8px; background: var(--secondary-bg-color); }
        [dir="ltr"] body { text-align: left; }
        [dir="rtl"] body { text-align: right; }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.7); display: flex; justify-content: center; align-items: center; z-index: 1000; }
        .modal-content { background-color: var(--secondary-bg-color); padding: 30px; border-radius: 8px; width: 90%; max-width: 500px; border: 1px solid var(--border-color); box-shadow: 0 5px 15px rgba(0,0,0,0.5); }
        .modal-content h3 { margin-top: 0; color: var(--secondary-accent-color); border-bottom: 1px solid var(--border-color); padding-bottom: 10px; margin-bottom: 20px; }
        .modal-content label { display: block; margin-top: 15px; margin-bottom: 5px; color: var(--text-color); }
        .modal-content input[type="text"], .modal-content textarea { width: 100%; padding: 10px; border-radius: 5px; border: 1px solid var(--border-color); background-color: var(--input-bg-color); color: var(--text-color); font-size: 1em; box-sizing: border-box; }
        .modal-actions { margin-top: 25px; display: flex; justify-content: flex-end; gap: 10px; }
        #pdf-export-container {
            position: absolute;
            left: -9999px;
            top: -9999px;
            width: 800px;
            padding: 20px;
            background: white;
            color: black;
        }
        #pdf-export-container h1, #pdf-export-container h2, #pdf-export-container h3 {
            color: #333;
            font-family: 'Vazirmatn', sans-serif;
        }
        #pdf-export-container .chart-container {
            border: 1px solid #ccc;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1 data-lang-key="header_title">آنالیز دانه‌بندی مصالح</h1>
            <div class="toolbar">
                <button id="lang-toggle" data-lang-key="lang_button">English</button>
                <button id="export-word" data-lang-key="export_word">خروجی Word</button>
                <button id="export-excel" data-lang-key="export_excel">خروجی Excel</button>
                <button id="export-pdf" data-lang-key="export_pdf">خروجی PDF</button>
            </div>
        </header>
        <main>
            <section id="material-selection">
                <h2 data-lang-key="material_selection_title">۱. انتخاب نوع مصالح و استاندارد</h2>
                <select id="material-type">
                    <option value="crushed-rock" data-lang-key="crushed_rock">سنگ شکن</option>
                    <option value="concrete-aggregates" data-lang-key="concrete_aggregates">بتن</option>
                    <option value="soil-clay" data-lang-key="soil_clay">رس</option>
                </select>
                <select id="sieve-standard">
                    <option value="astm" data-lang-key="astm">ASTM</option>
                    <option value="iso" data-lang-key="iso">ISO</option>
                    <option value="aashto" data-lang-key="aashto">AASHTO</option>
                </select>
            </section>
            <section id="sieve-inputs">
                <h2 data-lang-key="sieve_inputs_title">۲. ورود اطلاعات سرندها</h2>
                <table id="sieve-table">
                    <thead>
                        <tr>
                            <th data-lang-key="sieve_size">اندازه سرند (µm)</th>
                            <th data-lang-key="retained_weight">وزن باقی‌مانده (گرم)</th>
                            <th data-lang-key="actions">عملیات</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
                <button id="add-row" data-lang-key="add_sieve">افزودن سرند</button>
                <button id="calculate" data-lang-key="calculate_button">محاسبه</button>
            </section>
            <section id="results" style="display: none;">
                <h2 data-lang-key="results_title">۳. نتایج آنالیز</h2>
                <div id="results-output">
                    <p><strong>D10:</strong> <span id="d10-value">-</span></p>
                    <p><strong>D30:</strong> <span id="d30-value">-</span></p>
                    <p><strong>D50 (Median):</strong> <span id="d50-value">-</span></p>
                    <p><strong>D60:</strong> <span id="d60-value">-</span></p>
                    <p><strong>D80:</strong> <span id="d80-value">-</span></p>
                    <p><strong data-lang-key="cu">ضریب یکنواختی (Cu):</strong> <span id="cu-value">-</span></p>
                    <p><strong data-lang-key="cc">ضریب انحنا (Cc):</strong> <span id="cc-value">-</span></p>
                    <p><strong data-lang-key="mean">میانگین وزنی (μm):</strong> <span id="mean-value">-</span></p>
                    <p><strong data-lang-key="std_dev">انحراف معیار:</strong> <span id="std-dev-value">-</span></p>
                    <p><strong data-lang-key="retained_75mm">درصد بزرگتر از ۷۵ میلی متر:</strong> <span id="retained-75mm-value">-</span></p>
                    <p><strong data-lang-key="retained_45mm">درصد بزرگتر از ۴۵ میلی متر:</strong> <span id="retained-45mm-value">-</span></p>
                </div>
                <div id="text-analysis-container" style="margin-top: 20px;">
                    <h3 data-lang-key="analysis_title">تحلیل متنی</h3>
                    <p id="text-analysis-output">-</p>
                </div>
            </section>
            <section id="charts" style="display: none;">
                <h2 data-lang-key="charts_title">۴. نمودارها</h2>
                <div class="chart-container" style="height: 400px; margin-bottom: 20px;"><canvas id="passing-curve-chart"></canvas></div>
                <div class="chart-container" style="height: 400px; margin-bottom: 20px;"><canvas id="retained-curve-chart"></canvas></div>
                <div class="chart-container" style="height: 400px;"><canvas id="histogram-chart"></canvas></div>
            </section>
        </main>
    </div>
    <div id="word-export-modal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <h3 data-lang-key="word_modal_title">اطلاعات گزارش Word</h3>
            <div>
                <label for="report-title" data-lang-key="word_modal_report_title">عنوان گزارش</label>
                <input type="text" id="report-title" placeholder="مثال: نتایج آنالیز سرندی سنگ شکن شماره ۲">
            </div>
            <div>
                <label for="report-desc" data-lang-key="word_modal_report_desc">توضیحات</label>
                <textarea id="report-desc" rows="4" placeholder="مثال: نمونه مربوط به ده روز دوم خرداد ماه ۱۴۰۲ می‌باشد."></textarea>
            </div>
            <div>
                <label for="report-date" data-lang-key="word_modal_report_date">تاریخ</label>
                <input type="text" id="report-date">
            </div>
            <div class="modal-actions">
                <button id="cancel-word-export" data-lang-key="word_modal_cancel">انصراف</button>
                <button id="confirm-word-export" data-lang-key="word_modal_confirm">تولید گزارش</button>
            </div>
        </div>
    </div>
    <div id="pdf-export-container"></div>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/docx@9.5.1/dist/index.iife.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.4.0/exceljs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chartjs-plugin-annotation/1.4.0/chartjs-plugin-annotation.min.js"></script>
    <script>
        // This is a placeholder for a Base64 encoded font. In a real scenario, this would be a very long string.
        const VAZIRMATN_FONT_BASE64 = "AAEAAAAPAIAAAwBwR0RFRqgcpLkAAW0IAAABqkdQT1PTVhWrAAFutAAAVHpHU1VCmJPDqAABwzAAABxOT1MvMmgKWMcAAAF4AAAAYGNtYXCmzm0LAAAWrAAAB/ZnYXNwAAAAEAABbQAAAAAIZ2x5ZvTNykYAACkYAAEJTGhlYWQXFi5rAAAA/AAAADZoaGVhD78JAwAAATQAAAAkaG10eDXuc0UAAAHYAAAU1GxvY2FQTpBDAAAerAAACmxtYXhwBVcA8wAAAVgAAAAgbmFtZaBBvNEAATJkAAAGbnBvc3SxJab2AAE41AAANCpwcmVwaAaMhQAAHqQAAAAHAAEAAAAhAMXwxJvJXw889QADCAAAAAAA0X399AAAAADe2Oa6/Cf7igthCHMAAAAGAAIAAAAAAAAAAQAACDT7tAAAC8b8J/xTC2EAAQAAAAAAAAAAAAAAAAAABTUAAQAABTUAlAAWAF0ABgABAAAAAAAAAAAAAAAAAAUAAQAEBIcBkAAFAAAFMwWZAAABHgUzBZkAAAPXAGYCEgAAAAAAAAAAAAAAAIAAIAOAAAAAAAAACAAAAAAgICAgAMAAAP/9CDT7tAAACJgFFAAAAEEgCAAABDoGZgAAACAABAOMAGQAAAAABTgAHQSGABQFcgB0B3r/8QY6AAkHev/xBjoACQU4AB0EhgAUBXIAdAU4AB0EhgAUBXIAdAU4AB0EhgAUBXIAdAU4AB0EhgAUBXIAdAU4AB0EhgAUBXIAdAU4AB0EhgAUBXIAdAU4AB0FOAAdBIYAFASGABQFcgB0BTgAHQSGABQFcgB0BTgAHQSGABQFcgB0BTgAHQSGABQFcgB0BPwAqQRRAIsFNQB4BHwAYQH8AAAFNQB4BHwAYQU1AHgEfABhBTUAeAR8AGEFNQB4BHwAYQVAAKkEgACLBUAAqQSAAIsFXgAlBID/vQWkACAEaAAUBIwAqQPmAIsFkQB3BIwAqQPmAIsFkQB3BIwAqQPmAIsFkQB3BIwAqQPmAIsFkQB3BIwAqQPmAIsFkQB3BIwAqQPmAIsFkQB3BIwAqQPmAIsFkQB3BIwAqQPmAIsFkQB3BIwAqQPmAIsFkQB3BYsAogTjAIsEjACpBIwAqQPmAIsD5gCLBZEAdwVeACUEgP+9BH8AXwPkAEMEbACpA8wAiwVzAHoErABkBXMAegVzAHoErABkBXMAegSsAGQFcwB6BKwAZARRAIsFtQCpBOQAiwWbAB4E4wAwBbUAqQTkAIsCLQC3AekAmAaXALcFuACYAi0AsQHpAI4CJf/sAen/yQIt/+oB6f/HAi3/1QHp/7ICLQCqAekAhwIt/98B6f+8Ai3/zQHp/6oCLQAXAekABQIt/7YB6f+TBGoANQPPACwEagA1A88ALAUFAKkFJACyBFUAiwUFAKkEVQCLBE8AqQO1AIsETwCiA7UAgwSM/+oE0v/qBE8AqQO1AIsETwCpA7UAiwRPAKkDtQCLBE8AIwO1AAEG/ACpBgIAiwivAKkFtQCpBOMAiwW1AKkFtQCpBOMAiwW1AKkCGACZAtAAXgTSAGwB1//SAdsAmQW1AKkE4wCLBbUAqQW1AKkE4wCLBbUAqQW1AKkE4wCLBbUAqQWBAHcEvABgB6EAaQakAGAFgQB3BLwAYAWBAHcEvABgBYEAdwS8AGAFgQB3BLwAYAWBAHcEvABgBX8AZgWBAHcEvABgBYEAdwS8AGAFUgByBPMAdgWBAHcEvABgBYEAdwS8AGAFgQB3BLwAYAUMAKkEXQCLBYEAbgS8AFoE7gCpBEoAigTuAKkESgCKBO4AqQRKAIoE7gCpBEoAigTAAFEEIABEBMAAUQQgAEQEwABRBCAARATAAFEEIABEBYcAXgTAAFEEIABEBCAARATGADIEJwApBMYAMgQnACkExgAyBCcAKQQnACkEugCnA/kAiwUwAIwEfQB1BbUAqQUwAIwEfQB1BbUAqQUwAIwEfQB1BbUAqQUwAIwEfQB1BTAAjAR9AHUFtQCpBTAAjAR9AHUFtQCpBZAAjAUwAIwEfQB1BbUAqQUwAIwEfQB1BbUAqQUwAIwEfQB1BbUAqQUwAIwEfQB1BbUAqQUwAIwEfQB1BbUAqQUYAB0EaAAUBxkAPQYVADEHGQA9BhUAMQcZAD0GFQAxBxkAPQYVADEFBAA6BFQAJwTOAA8EKwAOBM4ADwQrAA4EzgAPBCsADgTOAA8EKwAOBM4ADwQrAA4EywBXBCMASATLAFcEIwBIBMsAVwQjAEgEywBXBCMASARaAG0EWgBtBFoAbQRaAG0CggB7AAD9bgRaAG0GwgBPBsIATwAAAAAAAAAAAAAAAAYrAIwAAAAABFoAbQRaAG0E+gBmBNYAaARaAG0EWgBtBIIAZQIF/9ACEP/NAhD/zQDF/88DE/++BFoAbQRaAG0DWABA BXEAgwNyABwHLwBoBFoAbQR+AIwDSQApAfQAsAK1AEACtQAUAh8AnAIfAAkDawCCAewAlAKzAIsEMABdBDAAXQOOAI4EMABdBDAAXQQwAF0B/AB0BGEAaQPEAKoCLACRAZMAHQIEAF0B/gCfBkkAXAOXAI8FtQBpBIMAXwRqAEYEkABXBRkAXwTIAF8C/QCDA1kAZQSMAIwEfwBuBCAARAHyAI4AAP04AfsAnAQ+AF0EPgBdBD4AXQQ+AF0EPgBdBD4AXQQ+AF0EPgBdBH8AcQLvAE8EpwCFBBAAYQLvAE8EfwBxBVoAlQQ+AF0GQACMBUEAjASJAJIEPgBdBD4AXQRkAJgFGACYBLEAfgIsAJEEIACRAfQAiwLIAD0E8wA9BtQAPQbUAD0EiwA9BG8AIAQBAIwEfwCaAu8AXARrAGUEEACBAu8AXAR/AHMGzwBkArr/4wR/ADUC7wA2BM8APgQQADEC7wA2BH8AIgOjADwEbAASBH4AYQQ6AB8EfgBhBH4AYQR+AGEEfgBhBMIAjAJ5ADkAAPynBC8AhwQvAIQDlgBmA5YAdwJnAGwCZwBaBGgAjQSGAAEEaACNAAD9XQL8AF8DuwCMAjQAjAF/AFICNACMAfIAjgH7AJYB+//RAfv/zwH7/7oB+//EA9wAjgH7/7IIOgBjAg3/rwHy//oB+/+bAer/vgIE/7QEDgCNBA4AjQR0AJsB8gCcAfIAkwSMAGwCiACcAfIAVgLOAJwEEQBIBBEAPQSnAFsENAAxBG4AfwH8AKEE7gA9BAgALAIqACMHBACLA6sAjwO7AIwBZgBoBIkAmwQEAIwEawCNBGsAjQZWAB8Ea/+7AiYAAARrAI0EawCNBH8AZALvAEoEugCCBBAAVgLvAEoEfwBeBGQAmANhAHoEawCNBO0AdwSQAFwEkABcBJAAXASQAFwEkABcB0QAYQIrADIEkABcBJMAXASQAFwEkABcBH8AqwPVAKAE EACZAu8AewR/APQGJgBUBjUAUAXcAFUC7wB7A5QAkwOkAHsEiQBcBIkAXASQAFwEfgCMA+oARAK8AIUCvAAnBJAAagXcAGkCLACRAhcAlAeqAEQGkQCnBEoAjARHAGEFjwCpBIwAXwPIAEsDygBEApAAiQLCACQC1ABpAtwAPAGaAGEBmgBPAZoAMAGYACQBZgBoArYAjQK2AI0ExQA/ArYAZAK2AFMGSgBbAq4AeQK1AJ8IdgCpBCEAXwQhAF8EIQBfBCEAXwQ4AGMEIQBfApAAiQToAFsBsQApBH8ATgLvADsELgBKBBAAQgLvADsEfwB2BmoAWgR/AIUC7wBWBJMAmQQPAHIC7wBWBH8AfgNMABICJgAABpsAXwSnAFsENAAxBK8ARgKeAAkCnv/0AsYACQScAJUEfwBfBFgADwQQAE8C7wA/BH8AOwbXAGUGOQBwAu8APwPGAHsAAPyjAAD8igUBAGgEfwBeBIIAgwQQAE8C7wBCBH8AdgLvAEIEaQCJBGkAiQRpAIkEaQCJBGkAiQRpAIkE8wCJBGkAiQRpAIkDnAAEA6YADQH7AJwCBv+0AjYAjAU1AHgEfABhBDAAXQVzAHoErABkBH4AYQH7//kExgAyBCcAKQKeAAkCBP+0BbUAqQRrAI0FOAAdBFoAOgSMAF8EPgApAi3/CwH7/vAFgQB3BJAAMwTuAFYCtv+MBTAAjARpACsEwABRBCEAXwTGADICngAJAgT/tAGaADADqwCPAloAfwAA/CcCLACJA0cAOAAAAHwAAAB8AAAAVQAAAH8CLACJA2gAYwM9AF0B2/9fAdsAIgOOAGMB2wAcBaUAYwHbAJkG/wBjA7oAYwb/AGMG/wBjBVoAWwVaAFsFWgBbA9QAYwPUAGMCvf/0Ar3/9Al0AGMJdABjCfsAYwn7AGMF7ABjBewAYwTzAGME8wBjBaUAYwUxAGMCfv98AsT/wgLs/+oDKP/sA5b/7ALn/3wDLf/CA1b/6gOS/+wD///sAjX/7AbvAGMFigBjBwwAYwUeAGMEwgBjBWoAYwO6AGMDjgBjBaUAYwWlAGMAAAA6AAAAGgAAAAUAAAA7AAAAQQAAABQAAAATAAAAOgAAABcAAAAZAAD/1wAAABkAAAAYAAAAKgAA//MAAAAlAAAAKwAAABcAAAAQAAAAQAAAAFcAAABAAAABdwAAAXcDAwCyBUUB0wJPAGIFRQH5BDAAYgVFAO0FRQBiBUUAYwO1AGkFRQEoBDwAaQVFAO4D6wBgBUUBLwS2AFEFRQCZBLYAUQVF AJkD2wBdBUUBNAPuAI4DYQBIAhUATgUiAKsG/wBjB28AYwJI/+wCsv/sBYoAYwWBAGMDqP/sA/v/7AAAAEAB2//MAi4AaAb/AGMG/wBjB28AYwKm/+wDEP/sBv8AYwVaAFsFgQBbBVz/7AV0/+wFWgBbBYEAWwVc/+wFdP/sBVoAWwPUAGMD1ABjBEEAYwK9//QCvf/0Axf/9AK9//QDF//0Ar3/9AMX//QCVf/0CXQAYwnlAGMGT//sBsH/7ATzAGMEzgBjBCz/7ASU/+wG7wBjB28AYwOo/+wD+//sBu8AYwcBAGMH2QBjCCwAYwZT/+wGpf/sBwEAYweJAGMDjf/sBBb/7AcMAGMHRwBjA43/7AQW/+wHDABjBwEAYwUeAGMFXABjAk7/7AKL/+wFagBjAkj/7AKy/+wFagBjBcUAYwJI/+wCwP/sArL/7AMq/+wFagBjBcUAYwYJADADugBjA7oAYwO6AGMDvQBjAkj/7AP8/+wDugBjA70AYwOOAGMDjgBjA44AYwOOAGMDjgBjA48AYwOOAGMFpQBjBk8ANQXlACYFpQBjBTEAYwJ+/3wCxP/CAuz/6gMo/+wDlv/sAuf/fAMt/8IDVv/qA5L/7AP//+wDjgBjA48AYwWlAGMCEAByBTEAYwJ0/+oDAP/tAt7/6gNq/+0HGQBjBxkAYwJkAGkDugBjBCYAYwAA/zwJqABvB+AAZgSrAHADYACJBUUBfAJPAGIFRQH5BDAAYgVFAO0FRQBiBUUAYwSSAGIE6wC2BUUAugVFAK0EuABpBUUAsAPlAHEFRQESBLYAUQRKAHMFRQDrBUUAmQS2AFEFRQCZA9sAXQVFATQHAQBjB4kAYwON/+wEFv/sBwEAYweJAGMDjf/sBBb/7AT8AKkEfgCMBUAAqQSD AF8FtQCpBGgAjQUFAKkEDgCNBQUAqQQOAI0ETwCpAfIAhgb8AKkHBACLBvwAqQcEAIsFtQCpBGsAjQWBAHcFDACpBH4AjATuAKkCtgCDBMAAUQQhAF8ExgAyAp4ACQUwAIwFGAAdA+AAIQUYAB0D4AAhBxkAPQYDACsEywBXA/gAWQU4AB0EWgBtBTgAHQRaAG0EjACpBD4AXQSMAKkEPgBdBIwAqQQ+AF0CLQC3AfsAnAItAKQB8gCGAfsAhgWBAHcEkABcBYEAdwSQAFwFfwBmBJMAXAV/AGYEkwBcBX8AZgSTAFwFfwBmBJMAXAV/AGYEkwBcBTAAjARpAIkFMACMBGkAiQWQAIwE8wCJBZAAjATzAIkFkACMBPMAiQWQAIwE8wCJBZAAjATzAIkEzgAPA8kAFgTOAA8DyQAWBM4ADwPJABYEFAAACCkAAAQUAAAIKQAAArkAAAIKAAABXAAABH8AAAIwAAABogAAAQAAAADRAAAAAAAABj8AjAPEAJUAAAAAAAAAAAAAAAAAAAAAAAAAACDAAAC7wA2BKEAXwXaAB8EIwArBHQAIQVIAF0FTwAfBKsAKAXoAHsDzgBoCDoAoggiAIsD1wDLA0wAEgTeAGYB2//MAhj/6gb/AGMHbwBjAn7/dwLE/70C7P/lAyj/7AOW/+wC5/93Ay3/vQNW/+UDkv/sA///7Ab/AGMHbwBjAlz/6wKz/+sG7wBjB28AYwOo/+wD+//sBVoAWwWBAFsFXP/sBXT/7APUAGMEQQBjAr3/9AMX//QCvf/0Axf/9AcBAGMHiQBjA43/7AQW/+wHAQBjB4kAYwON/+wEFv/sBWoAYwXFAGMEJgBjA70AYwJI/+wD/P/sBgkAMAR4ADIFj//sA/z/7AcZAGMGcABjBOsAYwcZAGMGbABfBOsAXwI3AGMDKgBpBwwAYwdHAGMDjf/sBBb/7AOOAGMDjwBjA44AYwOPAGMDjgBjA48AYwOOAGMDjwBjA44AYwOPAGMCSP/sArL/7AWlAGMFMQBjAn7/fALE/8IC7P/qAyj/7AOW/+wC5/98Ay3/wgNW/+oDkv/sA///7ANvAHcDbwAxChIAYwvGAGMCUABTAl7/7gLnADwCswBpAlAAUwJQAFUCXv/uAlAASAJe/+4CUABTAl7/7gJQABQCXv/uAlAAeQJe/+4DPQBdAdv/XwIY/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AgAEAAQAAgAEAAQAAgAEAAQAAgAEAAQAAgAEAAQAAgAEAAQAAgAEAAQAAgAEAAQAAgAEAAQAAgAEAAQAAgAEAAQAAgAEAAQAAgAEAAQAAgAEAAQAAgAEAAQAAgAEAAQAAgAEAAQAAgAEAAQAAgAEAAQAAgAEAAQAAgAEAAQAAgAEAAQAAgAEAAQAAgAEAAQAAgAEAAQAAgAEAAQAAgAEAAQAAgAEAAQAAgAEAAQAAgAEAAQAAgAEAAQAAgAEAAQAAgAEAAQAAgAEAAQAAgAEAAQAAgAEAAQAAgAEAAQAAgAEAAQAAgAEAAQAAgAEAAQAAgAEAAQAAgAEAAQAAgAEAAQAAgAEAAQAAgAEAAQAAgAEAAQAAgAEAAQAAgAEAAQAAgAEAAQAAgAEAAQAAgAEAAQAAgAEAAQAAgAEAAQAAgAEAAQAAgAEAAQAAgAEAAQAAgAEAAQAAgAEAAQAAgAEAAQAAgAEAAQAAgAEAAQAAgAEAAQAAgAEAAQAAgAEAAQAAgAEAAQAAgAEAAQAAgAEAAQAAgAEAAQAAgAEAAQAAgAEAAQAAgAEAAQAAgAEAAQAAgAEAAQAAgAEAAQAAgAEAAQAAgAEAAQAAgAEAAQAAgAEAAQAAgAEAAQAAgAEAAQAAgAEAAQAAgAEAAQAAgAEAAQAAgAEAAQAAgAEAAQAAgAEAAQAAgAEAAQAAgAEAAQAAgAEAAQAAgAEAAQAAgAEAAQAAgAEAAQAAgAEAAQAAgAEAAQAAgAEAAQAAgAEAAQAAgAEAAQAAgAEAAQAAgAEAAQAAgAEAAQAAgAEAAQAAgAEAAQAAgAEAAQAAgAEAAQAAgAEAAQAAgAEAAQAAgAEAAQAAgAEAAQAAgAEAAQAAgAEAAQAAgAEAAQAAgAEAAQAAgAEAAQAAgAEAAQAAgAEAAQAAgAEAAQAAgAEAAQAAgAEAAQAAgAEAAQAAgAEAAQAAgAEAAQAAgAEAAQAAgAEAAQAAgAEAAQAAgAEAAQAAgAEAAQAAgAEAAQAAgAEAAQAAgAEAAQAAgAEAAQAAgAEAAQAAgAEAAQAAgAEAAQAAgAEAAQAAgAEAAQAAgAEAAQAAgAEAAQAAgAEAAQAAgAEAAQAAgAEAAQAAgAEAAQAAgAEAAQAAgAEAAQAAgAEAAQAAgAEAAQAAgAEAAQAAgAEAAQAAgAEAAQAAgAEAAQAAgAEAAQAAgAEAAQAAgAEAAQAAgAEAAQAAgAEAAQAAgAEAAQAAgAEAAQAAgAEAAQAAgAEAAQAAgAEAAQAAgAEAAQAAgAEAAQAAgAEAAQAAgAEAAQAAgAEAAQAAgAEAAQAAgAEAAQAAgAEAAQAAgAEAAQAAgAEAAQAAgAEAAQAAgAEAAQAAgAEAAQAAgAEAAQAAgAEAAQAAgAEAAQAAgAEAAQAAgAEAAQAAgAEAAQAAgAEAAQAAgAEAAQAAgAEAAQAAgAEAAQAAgAEAAQAAgAEAAQAAgAEAAQAAgAEAAQAAgAEAAQAAgAEAAQAAgAEAAQAAgAEAAQAAgAEAAQAAgAEAAQAAgAEAAQAAgAEAAQAAgAEAAQAAgAEAAQAAgAEAAQAAgAEAAQAAgAEAAQAAgAEAAQAAgAEAAQAAgAEAAQAAgAEAAQAAgAEAAQAAgAEAAQAAgAEAAQAAgAEAAQAAgAEAAQAAgAEAAQAAgAEAAQAAgAEAAQAAgAEAAQAAgAEAAQAAgAEAAQAAgAEAAQAAgAEAAQAAgAEAAQAAgAEAAQAAgAEAAQAAgAEAAQAAgAEAAQAAgAEAAQAAgAEAAQAAgAEAAQAAgAEAAQAAgAEAAQAAgAEAAQAAgAEAAQAAgAEAAQAAgAEAAQAAgAEAAQAAgAEAAQAAgAEAAQAAgAEAAQAAgAEAAQAAgAEAAQAAgAEAAQAAgAEAAQAAgAEAAQAAgAEAAQAAgAEAAQAAgAEAAQAAgAEAAQAAgAEAAQAAgAEAAQAAgAEAAQAAgAEAAQAAgAEAAQAAgAEAAQAAgAEAAQAAgAEAAQAAgAEAAQAAgAEAAQAAgAEAAQAAgAEAAQAAgAEAAQAAgAEAAQAAgAEAAQAAgAEAAQAAgAEAAQAAgAEAAQAAgAEAAQAAgAEAAQAAgAEAAQAAgAEAAQAAgAEAAQAAgAEAAQAAgAEAAQAAgAEAAQAAgAEAAQAAgAEAAQAAgAEAAQAAgAEAAQAAgAEAAQAAgAEAAQAAgAEAAQAAgAEAAQAAgAEAAQAAgAEAAQAAgAEAAQAAgAEAAQAAgAEAAQAAgAEAAQAAgAEAAQAAgAEAAQAAgAEAAQAAgAEAAQAAgAEAAQAAgAEAAQAAgAEAAQAAgAEAAQAAgAEAAQAAgAEAAQAAgAEAAQAAg-EAIAgAAAAAAAAAAAAAAAP//AAkAAQADAAcACQALABIAEwAWABkAGgAA//8ACgAAAAIABQAGAAgADAANABQAFQAXABgAGQAaABsAAP//AA0AAAACAAUABgAIAAwADQAOABQAFQAXABgAGwAA//8ADQAAAAIABQAGAAgADAANAA8AFAAVABcAGAAbAAD//wANAAAAAgAFAAYACAAMAA0AEAAUABUAFwAYABsAAP//AA0AAAACAAUABgAIAAwADQARABQAFQAXABgAGwAA//8ADAAAAAIABQAGAAgACgANABQAFQAXABgAGwAcYzJzYwCqY2FsdACwY2NtcAC2Y2NtcAC+Y2NtcADEZGxpZwDOZG5vbQDUZmluYQDaZnJhYwDgaW5pdADqbGlnYQDwbGlnYQD2bGlnYQD+bG51bQEGbG9jbAEMbG9jbAESbG9jbAEYbG9jbAEebG9jbAEkbWVkaQEqbnVtcgEwb251bQE2cmxpZwE8c2FsdAFCc21jcAFIc3MwMQFOdG51bQFYdW5pYwFeAAAAAQAAAAAAAQAcAAAAAgAEAAUAAAABABoAAAADAAQABQAaAAAAAQAMAAAAAQAUAAAAAQAWAAAAAwAQABEAEwAAAAEAGAAAAAEACwAAAAIAIAAhAAAAAgAKAAsAAAABAA8AAAABAAkAAAABAAYAAAABAAgAAAABAAcAAAABACIAAAABABcAAAABABUAAAABAA4AAAABABkAAAABAA0AAAABAAEABgABACMAAAEAAAAAAQAkAAAAAQACACUATAKyBNAHZgd8B/oOHg4eDjgOVg5qDo4OuA70DwoPTA+OD6IP1g/4D9YP+BAyEaASHBMKE1QUFhR4FnYWphbMFw4XbBhcGHoY3AAMABgAIAAoADQAQABMAFgAZAB0AHgAhACQAJwAqACwALwAxADMANQA3ADkAOwA9AD8AQgBFAEgASwBOAFEAVABXAFoAXQBeAGEAYwBlAGcAagBsAG4AcQBzAHUAdwB5AHsAfQB/AIEAgwCFAIcAiQCLAI0AjwCSAJQAlgCYAJwAngCgAKIApACnAKoAsgC1ALgAuwC9AL8AwQDDAMUAxwDKAMwAzgDQANIA1ADWANgA2gDcAN4A4ADiAOQA5gDoAOsA7gDwAPIA9QD3APoA/QEAAQIBBQEJAQwBDwESARUBGAEaARwBHgEgASIBJAEmASgBKgEsAS4BMAEyATQBRgF5AYgBogGqAeEB9wILAkUCTAJTAlsCZwJ6An0CgQDsAPMEFgQaBSkFMgABAJUAAgAFAAcACQAMAA8AEgAVABgAGwAcACAAIwAmACkAKwAuADAAMgA0ADYAOAA6ADwAPgBBAEQARwBKAE0AUABTAFYAWQBbAFwAYABiAGQAZgBpAGsAbQBwAHIAdAB2AHgAegB8AH4AgACCAIQAhgCIAIoAjACOAJAAkwCVAJcAmwCdAJ8AoQCjAKYAqQCxALQAtwC6ALwAvgDAAMIAxADGAMkAywDNAM8A0QDTANUA1wDZANsA3QDfAOEA4wDlAOcA6gDtAO8A8QD0APYA+QD8AP8BAQEEAQgBCwEOAREBFAEXARkBGwEdAR8BIQEjASUBJwEpASsBLQEvATEBMwFFAXgBhQGfAacB4AH0AgkCQgJJAlICWQJlAnkCfAKAApIClAQVBBkFKAUvAAEAAAABAAgAAgEMAIMAAwAKAA0AEAATAAYACAAWABkBRgAdAB4AIQAkACcAKgAsAC8AMQAzADUANwA5ADsAdwA/AEIARQBIAEsATgBRAFQAVwBaAF0AXgBhAGUAZwBqAGwAbgBvAHEAcwB1AHcAewB9AH8AgQCFAHkAhwCJAIsAjQCPAJIAlACWAJgAnACeAKAAogCkAKcAqgCyALUAuAC7AL8AwQDDAMUAvQDHAMoAzADQANIA1ADWANgA2gDcAN4A4ADiAOQA5gDoAOsA7gDwAPIA9QD3APoA/QEA AQIBBQEJAQwCegJ9AoEA7ADzAQ8BEgEVARgBGgEcAR4BIAEiASQBJgEoASoBLAEuATABMgE0AAEAggE1ATYBNwE4ATsBPAE9AUMBRAFFAUcBSAFPAVABVQFWAWABYQFjAWQBZQFwAXMBdAF8AX0BfgF/AYABgQGCAYMBhAGMAY8BkAGRAZQBmAGvAbIBswG0AbUBvgG/AcABxwHIAckBygHLAcwBzQHOAdEB0gHTAdQB1QHWAdgB2QHbAdwB3QHmAecB7QHuAfIB8wH8Af4B/wIAAgECAgIDAgUCBwIIAhQCFQIWAhcCJAIwAjECMwI0AjkCOgI7AjwCPgJVAlYCVwJYAmsCbAJtAm4CbwJwAnICcwJ7An4CggKTApUF GgUbBRwFHQUeBR8FIAUhBSMFJAUlBSYFJwUqBSsFLAUtBS4AAQAAAAEACAACAUgAoQAEAAsADgARABQAFwAaAB8AIgAlACgAQABDAEYASQBMAE8AUgBVAFgAXwClAKgAqwCzALYAuQD4APsA/gEDAQYBCgENARABEwEWAAQACwAOABEAFAAFAAcAFwAaAB8AIgAlACgAKQArAC4AMAAyADQANgA4ADoAQABDAEYASQBMAE8AUgBVAFgAWQBfAGAAZABmAGkAawBtAHAAcgB0AHYAegB8AH4AgACEAHgAhgCIAIoAjACOAJAAkwCVAJcAmwCdAJ8ApQCoAKsAswC2ALkAugC+AMAAwgDEALwAxgDJAMsAzwDRANMA1QDXANkA2wDdAN8A4QDjAOUA5wDqAO0A7wDxAPQA+AD7AP4A/wEDAQYBCgENAnkCfAKAApIBEAETARYBFwEZARsBHQEfASEBIwElAScBKQErAS0BLwExATMAAQChAAIACQAMAA8AEgAVABgAGwAgACMAJgA+AEEARABHAEoATQBQAFMAVgBbAKMApgCpALEAtAC3APYA+QD8AQEBBAEIAQsBDgERARQBNQE2ATcBOAE7ATwBPQFDAUQBRwFPAVABVQFWAWABYQFjAWQBZQFwAXMBdAF9AX4BfwGAAYEBggGDAYQBjAGPAZABlAGYAa8BsgGzAbQBvgG/AcABxwHIAckBygHLAcwBzQHOAdEB0gHTAdQB1QHWAdgB2QHbAdwB3QHnAe0B7gHyAfMB/AH+Af8CAAIBAgICAwIFAgcCCAIUAhUCFgIXAiQCMAIxAjMCNAI5AjoCOwI8Aj4CVQJWAlcCWAJrAmwCbQJuAm8CcAJyAnMCewJ+AoICkwUaBRsFHAUdBR4FHwUgBSEFIwUkBSUFJgUnBSoFKwUsBS0FLgABAAAAAQAIAAIALAAEAnYCfwJ3A9cAAQACAAwAFAEVAhUCEQIVAhUCFQIVAhUCEQABAAAAAQAIAAIAGgAKAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIVAhUCEQIAAA==";
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            let passingChart, retainedChart, histogramChart;
            let lastCalculationData = null;
            const exportWordBtn = document.getElementById('export-word');
            const exportExcelBtn = document.getElementById('export-excel');
            const exportPdfBtn = document.getElementById('export-pdf');
            const langToggleBtn = document.getElementById('lang-toggle');
            const wordModal = document.getElementById('word-export-modal');
            const cancelWordExportBtn = document.getElementById('cancel-word-export');
            const confirmWordExportBtn = document.getElementById('confirm-word-export');
            const reportDateInput = document.getElementById('report-date');

            exportWordBtn.addEventListener('click', showWordModal);
            exportPdfBtn.addEventListener('click', exportToPdf);
            cancelWordExportBtn.addEventListener('click', () => wordModal.style.display = 'none');
            confirmWordExportBtn.addEventListener('click', exportToWord);
            exportExcelBtn.addEventListener('click', exportToExcel);
            langToggleBtn.addEventListener('click', toggleLanguage);
            let passingChart, retainedChart, histogramChart;
            let lastCalculationData = null;

            const exportWordBtn = document.getElementById('export-word');
            const exportExcelBtn = document.getElementById('export-excel');
            const langToggleBtn = document.getElementById('lang-toggle');
            const wordModal = document.getElementById('word-export-modal');
            const cancelWordExportBtn = document.getElementById('cancel-word-export');
            const confirmWordExportBtn = document.getElementById('confirm-word-export');
            const reportDateInput = document.getElementById('report-date');

            function setupExportHandler(button, exportFn, requiresModal = false) {
                const eventTarget = requiresModal ? button : document.getElementById(button.id.replace('confirm', 'export'));

                eventTarget.addEventListener('click', async () => {
                    if (!lastCalculationData) {
                        alert(translations[currentLang]['alert_no_calculation']);
                        return;
                    }

                    if (requiresModal) {
                        showWordModal();
                        // The actual export is triggered by the modal's confirm button
                        confirmWordExportBtn.onclick = async () => {
                            await executeExport(confirmWordExportBtn, exportFn);
                            wordModal.style.display = 'none';
                        };
                    } else {
                        await executeExport(eventTarget, exportFn);
                    }
                });
            }

            async function executeExport(button, exportFn) {
                const originalButtonText = button.textContent;
                button.textContent = translations[currentLang]['generating'];
                button.disabled = true;

                try {
                    await exportFn();
                } catch (e) {
                    console.error(`Error during export: ${e.message}`, e);
                    alert(`An error occurred during export. Please check the console for details.`);
                } finally {
                    button.textContent = originalButtonText;
                    button.disabled = false;
                }
            }

            setupExportHandler(exportExcelBtn, exportToExcel);
            setupExportHandler(exportPdfBtn, exportToPdf);
            setupExportHandler(confirmWordExportBtn, exportToWord, true);

            cancelWordExportBtn.addEventListener('click', () => wordModal.style.display = 'none');
            langToggleBtn.addEventListener('click', toggleLanguage);

            Chart.defaults.color = 'rgba(236, 240, 241, 0.8)';
            Chart.defaults.borderColor = 'rgba(74, 98, 122, 0.5)';
            Chart.defaults.plugins.legend.labels.boxWidth = 20;
            Chart.defaults.plugins.legend.labels.padding = 20;

            const SIEVE_STANDARDS = {
                astm: [75000, 50000, 37500, 25000, 19000, 12500, 9500, 4750, 2360, 1180, 600, 300, 150, 75],
                iso: [80000, 63000, 50000, 40000, 31500, 25000, 20000, 16000, 12500, 10000, 8000, 6300, 5000, 4000, 2800, 2000, 1400, 1000, 500, 250, 125, 63],
                aashto: [75000, 63000, 50000, 37500, 25000, 19000, 12500, 9500, 4750, 2000, 425, 180, 75]
            };

            const addRowBtn = document.getElementById('add-row');
            const calculateBtn = document.getElementById('calculate');
            const sieveTableBody = document.querySelector('#sieve-table tbody');
            const standardSelect = document.getElementById('sieve-standard');

            function addSieveRow(size = '', weight = '') {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><input type="number" class="sieve-size" placeholder="e.g., 4750" value="${size}"></td>
                    <td><input type="number" class="retained-weight" placeholder="e.g., 500" value="${weight}"></td>
                    <td><button class="delete-row" data-lang-key="delete_button">حذف</button></td>
                `;
                sieveTableBody.appendChild(row);
                row.querySelector('.delete-row').addEventListener('click', () => row.remove());
            }

            function loadStandardSieves() {
                sieveTableBody.innerHTML = '';
                SIEVE_STANDARDS[standardSelect.value].forEach(size => addSieveRow(size));
                const panRow = document.createElement('tr');
                panRow.innerHTML = `
                    <td><input type="text" class="sieve-size" value="Pan" readonly></td>
                    <td><input type="number" class="retained-weight" placeholder="Weight on Pan"></td>
                    <td></td>
                `;
                sieveTableBody.appendChild(panRow);
            }

            addRowBtn.addEventListener('click', () => addSieveRow());
            standardSelect.addEventListener('change', loadStandardSieves);
            calculateBtn.addEventListener('click', performCalculations);

            loadStandardSieves();

            function performCalculations() {
                let sieves = [];
                sieveTableBody.querySelectorAll('tr').forEach(row => {
                    const sizeInput = row.querySelector('.sieve-size');
                    const weightInput = row.querySelector('.retained-weight');
                    const isPan = sizeInput.value.toLowerCase() === 'pan';
                    const size = isPan ? 0 : parseFloat(sizeInput.value);
                    const weight = parseFloat(weightInput.value) || 0;
                    if (!isNaN(size) && weight >= 0) sieves.push({ size, weight, isPan });
                });

                sieves.sort((a, b) => b.size - a.size);
                const totalWeight = sieves.reduce((sum, s) => sum + s.weight, 0);
                if (totalWeight === 0) {
                    alert(translations[currentLang]['alert_no_weight']);
                    return;
                }

                let cumulativeRetained = 0;
                let passingData = [];
                sieves.forEach(sieve => {
                    cumulativeRetained += sieve.weight;
                    sieve.cumulativeRetainedPercent = (cumulativeRetained / totalWeight) * 100;
                    sieve.passingPercent = 100 - sieve.cumulativeRetainedPercent;
                    if (!sieve.isPan) passingData.push({ size: sieve.size, passing: sieve.passingPercent });
                });

                const firstSieveSize = passingData.length > 0 ? passingData[0].size : 0;
                passingData.unshift({ size: firstSieveSize * 2, passing: 100 });

                const d10 = getDiameterForPassing(10, passingData);
                const d30 = getDiameterForPassing(30, passingData);
                const d50 = getDiameterForPassing(50, passingData);
                const d60 = getDiameterForPassing(60, passingData);
                const d80 = getDiameterForPassing(80, passingData);

                document.getElementById('d10-value').textContent = d10.toFixed(3);
                document.getElementById('d30-value').textContent = d30.toFixed(3);
                document.getElementById('d50-value').textContent = d50.toFixed(3);
                document.getElementById('d60-value').textContent = d60.toFixed(3);
                document.getElementById('d80-value').textContent = d80.toFixed(3);

                const cu = (d10 > 0) ? (d60 / d10) : 0;
                const cc = (d10 > 0 && d60 > 0) ? ((d30 * d30) / (d10 * d60)) : 0;
                document.getElementById('cu-value').textContent = cu ? cu.toFixed(2) : 'N/A';
                document.getElementById('cc-value').textContent = cc ? cc.toFixed(2) : 'N/A';

                let weightedMeanSum = 0;
                let particleData = [];
                const nonPanSieves = sieves.filter(s => !s.isPan);
                for (let i = 0; i < nonPanSieves.length; i++) {
                    const upperSize = (i === 0) ? nonPanSieves[i].size * 2 : nonPanSieves[i - 1].size;
                    const meanSize = Math.sqrt(upperSize * nonPanSieves[i].size);
                    if (nonPanSieves[i].weight > 0) {
                        particleData.push({ meanSize, weight: nonPanSieves[i].weight });
                        weightedMeanSum += meanSize * nonPanSieves[i].weight;
                    }
                }
                const panWeight = sieves.find(s => s.isPan)?.weight || 0;
                if (panWeight > 0 && nonPanSieves.length > 0) {
                    const meanSize = nonPanSieves[nonPanSieves.length - 1].size / 2;
                    particleData.push({ meanSize, weight: panWeight });
                    weightedMeanSum += meanSize * panWeight;
                }
                const weightedMean = totalWeight > 0 ? weightedMeanSum / totalWeight : 0;
                let varianceSum = 0;
                if (totalWeight > 0) particleData.forEach(p => varianceSum += Math.pow(p.meanSize - weightedMean, 2) * p.weight);
                const standardDeviation = Math.sqrt(totalWeight > 0 ? varianceSum / totalWeight : 0);

                document.getElementById('mean-value').textContent = weightedMean.toFixed(3);
                document.getElementById('std-dev-value').textContent = standardDeviation.toFixed(2);

                let passing75mm, passing45mm;

                const sieve75mm = sieves.find(s => s.size === 75000);
                if (sieve75mm) {
                    passing75mm = sieve75mm.passingPercent;
                } else {
                    passing75mm = getPassingForDiameter(75000, passingData) ?? 0;
                }

                const sieve45mm = sieves.find(s => s.size === 45000);
                if (sieve45mm) {
                    passing45mm = sieve45mm.passingPercent;
                } else {
                    passing45mm = getPassingForDiameter(45000, passingData) ?? 0;
                }

                const retained75mm = 100 - passing75mm;
                const retained45mm = 100 - passing45mm;

                document.getElementById('retained-75mm-value').textContent = retained75mm.toFixed(2) + ' %';
                document.getElementById('retained-45mm-value').textContent = retained45mm.toFixed(2) + ' %';

                const materialType = document.getElementById('material-type').value;
                const fmSieveSizes = [9500, 4750, 2360, 1180, 600, 300, 150]; // Standard sieves for FM
                const cumulativeRetainedOnFMSieves = sieves
                    .filter(s => fmSieveSizes.includes(s.size))
                    .reduce((sum, s) => sum + s.cumulativeRetainedPercent, 0);
                const finenessModulus = cumulativeRetainedOnFMSieves > 0 ? cumulativeRetainedOnFMSieves / 100 : 0;

                const dValues = { d10, d30, d50, d60, d80 };
                const coeffs = { cu, cc };
                const stats = { mean: weightedMean, stdDev: standardDeviation, retained75mm, retained45mm, fm: finenessModulus };

                const analysisKeys = generateTextAnalysis(coeffs, dValues, stats, materialType, passingData);
                const analysisText = analysisKeys.map(key => {
                    if (typeof key === 'object') {
                        return (translations[currentLang][key.key] || key.key).replace('{value}', key.value);
                    }
                    return translations[currentLang][key] || key;
                }).join(' ');
                document.getElementById('text-analysis-output').textContent = analysisText;

                lastCalculationData = {
                    sieves, dValues, coeffs, analysisKeys, analysisText, stats, passingData
                };

                document.getElementById('results').style.display = 'block';
                document.getElementById('charts').style.display = 'block';
                updateCharts();
            }

            function generateTextAnalysis(coeffs, dValues, stats, materialType, passingData) {
                const { cu, cc } = coeffs;
                const { fm } = stats;
                const { d80 } = dValues;
                const keys = [];

                const passing75micron = getPassingForDiameter(75, passingData);
                if (passing75micron === null) return ['analysis_err_no_fines'];

                const passing4750micron = getPassingForDiameter(4750, passingData);
                if (passing4750micron === null) return ['analysis_err_no_split'];

                const finesPercent = passing75micron;
                const gravelPercent = 100 - passing4750micron;
                const sandPercent = 100 - finesPercent - gravelPercent;

                keys.push('analysis_title_uscs');
                if (finesPercent > 50) {
                    keys.push('analysis_fine_grained');
                } else {
                    keys.push({key: 'analysis_coarse_grained', value: (100-finesPercent).toFixed(1)});
                    const coarseFractionIsGravel = gravelPercent > sandPercent;

                    if (coarseFractionIsGravel) {
                        keys.push({key: 'analysis_base_gravel', value: gravelPercent.toFixed(1)});
                        if (finesPercent < 5) {
                            keys.push('analysis_fines_lt_5');
                            if (cu >= 4 && cc >= 1 && cc <= 3) keys.push('analysis_gw'); else keys.push('analysis_gp');
                        } else if (finesPercent > 12) {
                            keys.push('analysis_fines_gt_12', 'analysis_plasticity_gm_gc');
                        } else {
                            keys.push('analysis_fines_borderline', 'analysis_dual_symbol_gravel');
                        }
                    } else {
                        keys.push({key: 'analysis_base_sand', value: sandPercent.toFixed(1)});
                        if (finesPercent < 5) {
                            keys.push('analysis_fines_lt_5');
                            if (cu >= 6 && cc >= 1 && cc <= 3) keys.push('analysis_sw'); else keys.push('analysis_sp');
                        } else if (finesPercent > 12) {
                            keys.push('analysis_fines_gt_12', 'analysis_plasticity_sm_sc');
                        } else {
                            keys.push('analysis_fines_borderline', 'analysis_dual_symbol_sand');
                        }
                    }
                    if (cu && cc) {
                        keys.push({key: 'analysis_cu_value', value: cu.toFixed(2)});
                        keys.push({key: 'analysis_cc_value', value: cc.toFixed(2)});
                    }
                }

                // Specific analysis based on material type
                if (materialType === 'concrete-aggregates') {
                    keys.push('analysis_title_concrete');
                    if (fm && fm > 0) {
                        keys.push({key: 'analysis_fm_value', value: fm.toFixed(2)});
                        if (fm >= 2.3 && fm <= 3.1) keys.push('analysis_fm_good');
                        else if (fm < 2.3) keys.push('analysis_fm_fine');
                        else keys.push('analysis_fm_coarse');
                    } else {
                        keys.push('analysis_fm_na');
                    }
                } else if (materialType === 'crushed-rock') {
                    keys.push('analysis_title_heap_leach');
                    if (finesPercent < 15) {
                        keys.push({key: 'analysis_heap_leach_fines_ok', value: finesPercent.toFixed(1)});
                    } else {
                        keys.push({key: 'analysis_heap_leach_fines_high', value: finesPercent.toFixed(1)});
                    }
                    if (d80) {
                        const d80_mm = d80 / 1000;
                        keys.push({key: 'analysis_heap_leach_d80', value: d80_mm.toFixed(1)});
                        if (d80_mm > 20) keys.push('analysis_heap_leach_d80_coarse');
                        else if (d80_mm < 5) keys.push('analysis_heap_leach_d80_fine');
                    }
                }

                return keys;
            }

            async function getChartImages() {
                const chartConfigs = [
                    { id: 'passing-curve-chart', title: translations[currentLang]['chart_title_passing'] },
                    { id: 'retained-curve-chart', title: translations[currentLang]['chart_title_retained'] },
                    { id: 'histogram-chart', title: translations[currentLang]['chart_title_histogram'] }
                ];
                const chartImages = [];
                for (const config of chartConfigs) {
                    const canvas = await html2canvas(document.getElementById(config.id), { backgroundColor: '#FFFFFF' });
                    chartImages.push({
                        buffer: canvas.toDataURL('image/png'),
                        title: config.title
                    });
                }
                return chartImages;
            }

            async function exportToExcel() {
                const workbook = new ExcelJS.Workbook();
                workbook.creator = 'Sieve Analysis App';
                workbook.created = new Date();
                workbook.views = [{
                    x: 0, y: 0, width: 10000, height: 20000,
                    firstSheet: 0, activeTab: 0, visibility: 'visible',
                    rtl: currentLang === 'fa'
                }];

                const { sieves, dValues, coeffs, stats, analysisText } = lastCalculationData;
                const isFa = currentLang === 'fa';

                // --- 1. Summary Sheet ---
                const summarySheet = workbook.addWorksheet(translations[currentLang].title, {
                    views: [{ state: 'normal', rightToLeft: isFa }]
                });

                summarySheet.mergeCells('A1:F1');
                const titleCell = summarySheet.getCell('A1');
                titleCell.value = translations[currentLang]['header_title'];
                titleCell.font = { name: 'Vazirmatn', size: 18, bold: true };
                titleCell.alignment = { horizontal: 'center', vertical: 'middle' };
                summarySheet.getRow(1).height = 40;

                const headerFill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'D9EAD3' } };
                const border = { top: { style: 'thin' }, left: { style: 'thin' }, bottom: { style: 'thin' }, right: { style: 'thin' } };

                summarySheet.mergeCells('A3:B3');
                const resultsTitle = summarySheet.getCell('A3');
                resultsTitle.value = translations[currentLang]['results_title'];
                resultsTitle.font = { name: 'Vazirmatn', size: 14, bold: true };
                resultsTitle.alignment = { horizontal: 'center' };

                const summaryHeader = summarySheet.addRow(['Parameter', 'Value']);
                summaryHeader.eachCell(cell => {
                    cell.font = { bold: true, name: 'Vazirmatn' };
                    cell.fill = headerFill;
                    cell.border = border;
                });

                const summaryData = [
                    ['D10 (µm)', dValues.d10], ['D30 (µm)', dValues.d30], ['D50 (µm)', dValues.d50],
                    ['D60 (µm)', dValues.d60], ['D80 (µm)', dValues.d80],
                    [translations[currentLang]['cu'], coeffs.cu],
                    [translations[currentLang]['cc'], coeffs.cc],
                    [translations[currentLang]['mean'], stats.mean],
                    [translations[currentLang]['std_dev'], stats.stdDev],
                    [translations[currentLang]['retained_75mm'], stats.retained75mm],
                    [translations[currentLang]['retained_45mm'], stats.retained45mm]
                ];

                summaryData.forEach(([label, value]) => {
                    const displayValue = (value !== null && typeof value !== 'undefined') ? parseFloat(value.toFixed(3)) : 'N/A';
                    const row = summarySheet.addRow([label, displayValue]);
                    row.eachCell(cell => {
                        cell.font = { name: 'Vazirmatn' };
                        cell.border = border;
                    });
                });

                summarySheet.getColumn('A').width = 35;
                summarySheet.getColumn('B').width = 20;

                const analysisHeaderRow = summarySheet.addRow([]);
                const analysisTitleRow = summarySheet.addRow([translations[currentLang]['analysis_title']]);
                summarySheet.mergeCells(`A${analysisTitleRow.number}:F${analysisTitleRow.number}`);
                analysisTitleRow.getCell(1).font = { bold: true, size: 14, name: 'Vazirmatn' };
                analysisTitleRow.getCell(1).alignment = { horizontal: 'center' };

                const analysisContentRow = summarySheet.addRow([analysisText]);
                summarySheet.mergeCells(`A${analysisContentRow.number}:F${analysisContentRow.number}`);
                analysisContentRow.getCell(1).alignment = { wrapText: true, vertical: 'top' };
                analysisContentRow.height = 80;

                // --- 2. Chart Images ---
                const chartSheet = workbook.addWorksheet(translations[currentLang]['charts_title']);
                const chartImages = await getChartImages();
                let chartY = 1;
                for (const chart of chartImages) {
                    const imageId = workbook.addImage({ base64: chart.buffer, extension: 'png' });
                    chartSheet.addImage(imageId, {
                        tl: { col: 1, row: chartY },
                        ext: { width: 500, height: 300 }
                    });
                    chartY += 16;
                }

                // --- 3. Raw Data Sheet ---
                const dataSheet = workbook.addWorksheet('Raw Data', {
                    views: [{ state: 'normal', rightToLeft: isFa }]
                });
                const dataHeader = dataSheet.addRow([
                    translations[currentLang]['sieve_size'],
                    translations[currentLang]['retained_weight'],
                    'Cumulative Retained (%)',
                    'Cumulative Passing (%)',
                ]);
                dataHeader.eachCell(cell => {
                    cell.font = { bold: true, name: 'Vazirmatn' };
                    cell.fill = headerFill;
                    cell.border = border;
                });

                sieves.forEach(s => {
                    const row = dataSheet.addRow([
                        s.isPan ? translations[currentLang]['pan'] : (s.size !== null ? s.size : ''),
                        s.weight !== null ? s.weight : 0,
                        s.cumulativeRetainedPercent !== null ? parseFloat(s.cumulativeRetainedPercent.toFixed(2)) : 0,
                        s.passingPercent !== null ? parseFloat(s.passingPercent.toFixed(2)) : 0,
                    ]);
                    row.eachCell(cell => {
                        cell.font = { name: 'Vazirmatn' };
                        cell.border = border;
                    });
                });

                dataSheet.columns.forEach(column => {
                    column.width = 25;
                });

                // --- 4. Generate File ---
                const buffer = await workbook.xlsx.writeBuffer();
                saveAs(new Blob([buffer]), 'Gradation_Analysis_Report.xlsx');
            }

            function showWordModal() {
                if (!lastCalculationData) {
                    alert(translations[currentLang]['alert_no_calculation']);
                    return;
                }
                reportDateInput.value = new Date().toLocaleDateString(currentLang === 'fa' ? 'fa-IR' : 'en-US');
                wordModal.style.display = 'flex';
            }

            async function exportToWord() {
                const { Document, Packer, Paragraph, TextRun, ImageRun, Table, TableCell, TableRow, WidthType, HeadingLevel, AlignmentType } = docx;
                const isFa = currentLang === 'fa';

                const reportTitle = document.getElementById('report-title').value || (isFa ? "گزارش تحلیل دانه‌بندی" : "Gradation Analysis Report");
                const reportDesc = document.getElementById('report-desc').value;
                const reportDate = document.getElementById('report-date').value;
                const { sieves, dValues, coeffs, stats, analysisText } = lastCalculationData;

                const chartImages = await getChartImages();

                const toFixedOrNA = (val, dp) => (val !== null && typeof val !== 'undefined') ? val.toFixed(dp) : 'N/A';
                const FONT_NAME = "Vazirmatn";

                const createStyledParagraph = (text, options = {}) => {
                    const paragraphOptions = {
                        children: [new TextRun({ text, font: FONT_NAME })],
                        bidirectional: isFa,
                        ...options,
                    };
                    return new Paragraph(paragraphOptions);
                };

                const createStyledTableCell = (text, options = {}) => new TableCell({
                    children: [createStyledParagraph(text, { alignment: AlignmentType.CENTER })],
                    ...options
                });

                const summaryRows = [
                    ...Object.entries(dValues).map(([key, value]) => new TableRow({ children: [createStyledTableCell(key), createStyledTableCell(toFixedOrNA(value, 3))] })),
                    new TableRow({ children: [createStyledTableCell("Cu"), createStyledTableCell(toFixedOrNA(coeffs.cu, 2))] }),
                    new TableRow({ children: [createStyledTableCell("Cc"), createStyledTableCell(toFixedOrNA(coeffs.cc, 2))] }),
                    new TableRow({ children: [createStyledTableCell("Fineness Modulus"), createStyledTableCell(toFixedOrNA(stats.fm, 2))] }),
                    new TableRow({ children: [createStyledTableCell("Retained > 75mm (%)"), createStyledTableCell(toFixedOrNA(stats.retained75mm, 2))] }),
                    new TableRow({ children: [createStyledTableCell("Retained > 45mm (%)"), createStyledTableCell(toFixedOrNA(stats.retained45mm, 2))] }),
                ];

                const dataRows = sieves.map(sieve => new TableRow({
                    children: [
                        createStyledTableCell(sieve.isPan ? translations[currentLang]['pan'] : (sieve.size !== null ? sieve.size.toString() : '')),
                        createStyledTableCell(sieve.weight !== null ? sieve.weight.toString() : '0'),
                        createStyledTableCell(toFixedOrNA(sieve.cumulativeRetainedPercent, 2)),
                        createStyledTableCell(toFixedOrNA(sieve.passingPercent, 2)),
                    ],
                }));

                const doc = new Document({
                    creator: "Sieve Analysis App",
                    title: reportTitle,
                    description: reportDesc,
                    fonts: [{ name: FONT_NAME, data: VAZIRMATN_FONT_BASE64 }],
                    styles: {
                        default: {
                            document: { run: { font: FONT_NAME, size: "11pt" } },
                            heading1: { run: { font: FONT_NAME, size: "16pt", bold: true, color: "2E74B5" } },
                            heading2: { run: { font: FONT_NAME, size: "14pt", bold: true } },
                        }
                    },
                    features: { updateFields: true },
                    settings: { view: new docx.View({ rtl: isFa }) },
                    sections: [{
                        children: [
                            createStyledParagraph(reportTitle, { heading: HeadingLevel.TITLE, alignment: AlignmentType.CENTER }),
                            createStyledParagraph(reportDate, { alignment: AlignmentType.CENTER, style: "IntenseQuote" }),
                            createStyledParagraph(reportDesc, { spacing: { after: 300 } }),
                            createStyledParagraph(translations[currentLang]['results_title'], { heading: HeadingLevel.HEADING_1 }),
                            new Table({
                                width: { size: 100, type: WidthType.PERCENTAGE },
                                rows: [
                                    new TableRow({
                                        children: [
                                            createStyledTableCell("Parameter", { shading: { fill: "D9EAD3" } }),
                                            createStyledTableCell("Value", { shading: { fill: "D9EAD3" } })
                                        ]
                                    }),
                                    ...summaryRows
                                ]
                            }),
                            createStyledParagraph(translations[currentLang]['analysis_title'], { heading: HeadingLevel.HEADING_1 }),
                            createStyledParagraph(analysisText, { spacing: { after: 300 } }),
                            createStyledParagraph(translations[currentLang]['charts_title'], { heading: HeadingLevel.HEADING_1, pageBreakBefore: true }),
                            ...chartImages.flatMap(img => [
                                new Paragraph({
                                    children: [new ImageRun({ data: img.buffer, transformation: { width: 500, height: 250 } })],
                                    alignment: AlignmentType.CENTER
                                }),
                                createStyledParagraph(img.title, { alignment: AlignmentType.CENTER, style: "Caption" })
                            ]),
                            createStyledParagraph("Raw Data", { heading: HeadingLevel.HEADING_1, pageBreakBefore: true }),
                            new Table({
                                width: { size: 100, type: WidthType.PERCENTAGE },
                                rows: [
                                    new TableRow({
                                        children: [
                                            createStyledTableCell(translations[currentLang]['sieve_size'], { shading: { fill: "D9EAD3" } }),
                                            createStyledTableCell(translations[currentLang]['retained_weight'], { shading: { fill: "D9EAD3" } }),
                                            createStyledTableCell('Cumulative Retained (%)', { shading: { fill: "D9EAD3" } }),
                                            createStyledTableCell('Passing (%)', { shading: { fill: "D9EAD3" } })
                                        ]
                                    }),
                                    ...dataRows
                                ]
                            }),
                        ]
                    }]
                });

                Packer.toBlob(doc).then(blob => {
                    saveAs(blob, "Sieve_Analysis_Report.docx");
                });
            }

            function exportToPdf() {
                if (!lastCalculationData) {
                    alert(translations[currentLang]['alert_no_calculation']);
                    return;
                }

                const { analysisText } = lastCalculationData;
                const isFa = currentLang === 'fa';
                const container = document.getElementById('pdf-export-container');
                const resultsClone = document.getElementById('results-output').cloneNode(true);
                const chartsClone = document.getElementById('charts').cloneNode(true);

                container.innerHTML = ''; // Clear previous content
                container.appendChild(resultsClone);
                container.appendChild(chartsClone);

                const opt = {
                    margin:       1,
                    filename:     'Gradation_Analysis_Report.pdf',
                    image:        { type: 'jpeg', quality: 0.98 },
                    html2canvas:  { scale: 2, useCORS: true, backgroundColor: null },
                    jsPDF:        { unit: 'in', format: 'letter', orientation: 'portrait' }
                };

                html2pdf().from(container).set(opt).save();
            }

            function updateCharts() {
                if (!lastCalculationData) return;
                const { sieves, stats, dValues, passingData } = lastCalculationData;
                const { mean, stdDev, retained75mm, retained45mm } = stats;
                const { d80 } = dValues;

                const labels = sieves.filter(s => !s.isPan).map(s => s.size).reverse();
                const passingPercent = sieves.filter(s => !s.isPan).map(s => s.passingPercent).reverse();
                const cumulativeRetainedPercent = sieves.filter(s => !s.isPan).map(s => s.cumulativeRetainedPercent).reverse();
                const totalWeight = sieves.reduce((sum, s) => sum + s.weight, 0);
                const retainedPercent = sieves.filter(s => !s.isPan).map(s => (s.weight / totalWeight) * 100).reverse();

                if (passingChart) passingChart.destroy();
                if (retainedChart) retainedChart.destroy();
                if (histogramChart) histogramChart.destroy();

                const passingAnnotations = {
                    d80Line: { type: 'line', yMin: 80, yMax: 80, borderColor: 'rgba(231, 76, 60, 0.8)', borderWidth: 2, borderDash: [6, 6], label: { content: `D80 = ${d80.toFixed(1)} µm`, enabled: true, position: 'start', backgroundColor: 'rgba(231, 76, 60, 0.8)' } },
                    d80point: { type: 'point', xValue: d80, yValue: 80, radius: 5, backgroundColor: 'rgba(231, 76, 60, 1)' }
                };

                const passingOptions = { responsive: true, maintainAspectRatio: false, plugins: { title: { display: true, text: translations[currentLang]['chart_title_passing'], color: 'white', font: { size: 18 } }, legend: { position: 'top' }, annotation: { annotations: passingAnnotations } }, scales: { x: { type: 'logarithmic', reverse: true, title: { display: true, text: translations[currentLang]['chart_xaxis_label'], color: 'white' }, ticks: { color: 'white' } }, y: { beginAtZero: true, max: 100, title: { display: true, text: translations[currentLang]['chart_yaxis_passing'], color: 'white' }, ticks: { color: 'white' } } } };
                passingChart = new Chart(document.getElementById('passing-curve-chart'), { type: 'line', data: { labels: labels, datasets: [{ label: translations[currentLang]['chart_legend_passing'], data: passingPercent, borderColor: '#3498db', backgroundColor: 'rgba(52, 152, 219, 0.2)', fill: true, tension: 0.1 }] }, options: passingOptions });

                const retainedAnnotations = {};
                if (retained75mm !== null) {
                    retainedAnnotations.line75k = { type: 'label', xValue: 75000, yValue: retained75mm, content: `${retained75mm.toFixed(1)}% @ 75mm`, backgroundColor: 'rgba(231, 76, 60, 0.8)', font: { size: 12 }, padding: 6, borderRadius: 6, yAdjust: -15 };
                }
                if (retained45mm !== null) {
                    retainedAnnotations.line45k = { type: 'label', xValue: 45000, yValue: retained45mm, content: `${retained45mm.toFixed(1)}% @ 45mm`, backgroundColor: 'rgba(231, 76, 60, 0.8)', font: { size: 12 }, padding: 6, borderRadius: 6, yAdjust: 15 };
                }

                const retainedOptions = { responsive: true, maintainAspectRatio: false, plugins: { title: { display: true, text: translations[currentLang]['chart_title_retained'], color: 'white', font: { size: 18 } }, legend: { position: 'top' }, annotation: { annotations: retainedAnnotations } }, scales: { x: { type: 'logarithmic', reverse: true, title: { display: true, text: translations[currentLang]['chart_xaxis_label'], color: 'white' }, ticks: { color: 'white' } }, y: { beginAtZero: true, max: 100, title: { display: true, text: translations[currentLang]['chart_yaxis_retained'], color: 'white' }, ticks: { color: 'white' } } } };
                retainedChart = new Chart(document.getElementById('retained-curve-chart'), { type: 'line', data: { labels: labels, datasets: [{ label: translations[currentLang]['chart_legend_retained'], data: cumulativeRetainedPercent, borderColor: '#e74c3c', backgroundColor: 'rgba(231, 76, 60, 0.2)', fill: true, tension: 0.1 }] }, options: retainedOptions });

                const histogramOptions = { responsive: true, maintainAspectRatio: false, plugins: { title: { display: true, text: translations[currentLang]['chart_title_histogram'], color: 'white', font: { size: 18 } }, legend: { display: false }, annotation: { annotations: { meanLine: { type: 'line', scaleID: 'x', value: mean, borderColor: '#e74c3c', borderWidth: 3, label: { content: `${translations[currentLang]['mean_label']}: ${mean.toFixed(0)} µm`, enabled: true, position: 'top', backgroundColor: 'rgba(231, 76, 60, 0.8)' } }, stdDevLabel: { type: 'label', xValue: mean, yValue: Math.max(...retainedPercent) * 0.9, backgroundColor: 'rgba(44, 62, 80, 0.7)', content: `${translations[currentLang]['std_dev_label']}: ${stdDev.toFixed(0)}`, font: { size: 12 }, padding: 6, borderRadius: 6 } } } }, scales: { x: { type: 'logarithmic', reverse: true, title: { display: true, text: translations[currentLang]['chart_xaxis_label'], color: 'white' }, ticks: { color: 'white' } }, y: { beginAtZero: true, title: { display: true, text: translations[currentLang]['chart_yaxis_retained_hist'], color: 'white' }, ticks: { color: 'white' } } } };
                histogramChart = new Chart(document.getElementById('histogram-chart'), { type: 'bar', data: { datasets: [{ label: translations[currentLang]['chart_legend_retained_hist'], data: labels.map((label, i) => ({ x: label, y: retainedPercent[i] })), backgroundColor: '#f1c40f', borderColor: '#f39c12', borderWidth: 1 }] }, options: histogramOptions });
            }

            function getDiameterForPassing(targetPassing, data) {
                let p1 = null, p2 = null;
                for (let i = 0; i < data.length - 1; i++) {
                    if (data[i].passing >= targetPassing && data[i + 1].passing <= targetPassing) {
                        p1 = data[i]; p2 = data[i + 1]; break;
                    }
                }
                if (!p1 || !p2 || p1.passing === p2.passing) {
                    if (targetPassing === 100 && data.length > 0) return data[0].size;
                    const lastPoint = data[data.length - 1];
                    if (targetPassing <= lastPoint.passing) return lastPoint.size;
                    return 0;
                }
                const logD = Math.log(p1.size) + (Math.log(p2.size) - Math.log(p1.size)) * (targetPassing - p1.passing) / (p2.passing - p1.passing);
                return Math.exp(logD);
            }

            function getPassingForDiameter(targetDiameter, data) {
                let p1 = null, p2 = null;
                for (let i = 0; i < data.length - 1; i++) {
                    if (data[i].size >= targetDiameter && data[i + 1].size <= targetDiameter) {
                        p1 = data[i]; p2 = data[i + 1]; break;
                    }
                }
                if (!p1 || !p2 || p1.size === p2.size) return null;
                const passing = p1.passing + (p2.passing - p1.passing) * (Math.log(targetDiameter) - Math.log(p1.size)) / (Math.log(p2.size) - Math.log(p1.size));
                return passing;
            }

            const translations = {
                en: {
                    title: "Gradation Analysis of Materials", header_title: "Gradation Analysis", lang_button: "فارسی", export_word: "Export Word", export_excel: "Export Excel", export_pdf: "Export PDF",
                    material_selection_title: "1. Select Material & Standard", crushed_rock: "Crushed Rock", concrete_aggregates: "Concrete Aggregates", soil_clay: "Soil/Clay",
                    astm: "ASTM", iso: "ISO", aashto: "AASHTO", sieve_inputs_title: "2. Enter Sieve Data", sieve_size: "Sieve Size (µm)", retained_weight: "Retained Weight (g)",
                    actions: "Actions", add_sieve: "Add Sieve", delete_button: "Delete", calculate_button: "Calculate", results_title: "3. Analysis Results", cu: "Coefficient of Uniformity (Cu):",
                    cc: "Coefficient of Curvature (Cc):", mean: "Weighted Mean (µm):", std_dev: "Standard Deviation:", analysis_title: "Text Analysis", charts_title: "4. Charts",
                    retained_75mm: "Percent Greater than 75mm:", retained_45mm: "Percent Greater than 45mm:",
                    alert_no_weight: "Total weight cannot be zero. Please enter retained weights.", alert_no_calculation: "Please perform a calculation first.", generating: "Generating...",
                    word_modal_title: "Word Report Information", word_modal_report_title: "Report Title", word_modal_report_desc: "Description", word_modal_report_date: "Date",
                    word_modal_cancel: "Cancel", word_modal_confirm: "Generate Report", pan: "Pan",
                    chart_title_passing: "Cumulative Passing Curve", chart_title_retained: "Cumulative Retained Curve", chart_title_histogram: "Histogram (Percent Retained)",
                    chart_xaxis_label: "Sieve Size (µm) - Log Scale", chart_yaxis_passing: "Passing (%)", chart_yaxis_retained: "Retained (%)", chart_yaxis_retained_hist: "Percent Retained (%)",
                    chart_legend_passing: "Cumulative Passing", chart_legend_retained: "Cumulative Retained", chart_legend_retained_hist: "Percent Retained", mean_label: "Mean", std_dev_label: "Std Dev",
                    analysis_err_no_fines: "Cannot determine fines percentage (no 75µm sieve data). Classification not possible.", analysis_err_no_coeffs: "Not enough data for soil classification. D10, D30, and D60 values are required.",
                    analysis_err_no_split: "Cannot determine sand/gravel split (no 4.75mm/4750µm sieve data). Classification not possible.",
                    analysis_title_uscs: "USCS Soil Classification: ",
                    analysis_fine_grained: "The material is fine-grained (over 50% passing 75µm sieve). Atterberg limits are needed for full classification.",
                    analysis_coarse_grained: "The material is coarse-grained ({value}% retained on 75µm sieve). ",
                    analysis_base_gravel: "The coarse fraction is primarily Gravel ({value}%). ",
                    analysis_base_sand: "The coarse fraction is primarily Sand ({value}%). ",
                    analysis_fines_lt_5: "Fines < 5%. ",
                    analysis_fines_gt_12: "Fines > 12%. ",
                    analysis_fines_borderline: "Borderline case (5-12% fines). ",
                    analysis_gw: "Classification: GW (Well-graded gravel).",
                    analysis_gp: "Classification: GP (Poorly-graded gravel).",
                    analysis_plasticity_gm_gc: "Further plasticity tests needed to classify as GM (silty gravel) or GC (clayey gravel).",
                    analysis_dual_symbol_gravel: "Requires dual symbol (e.g., GW-GM, GP-GC).",
                    analysis_sw: "Classification: SW (Well-graded sand).",
                    analysis_sp: "Classification: SP (Poorly-graded sand).",
                    analysis_plasticity_sm_sc: "Further plasticity tests needed to classify as SM (silty sand) or SC (clayey sand).",
                    analysis_dual_symbol_sand: "Requires dual symbol (e.g., SW-SM, SP-SC).",
                    analysis_cu_value: "Cu = {value}. ",
                    analysis_cc_value: "Cc = {value}. ",
                    analysis_title_concrete: "\nConcrete Aggregate Analysis: ",
                    analysis_fm_value: "Fineness Modulus (FM) = {value}. ",
                    analysis_fm_good: "This FM is within the typical range (2.3-3.1) for fine aggregate (ASTM C33).",
                    analysis_fm_fine: "This indicates the sand is finer than is typical for concrete aggregate.",
                    analysis_fm_coarse: "This indicates the sand is coarser than is typical for concrete aggregate.",
                    analysis_fm_na: "Fineness Modulus could not be calculated. Ensure standard sieves are included.",
                    analysis_title_heap_leach: "\nHeap Leach (Oxidized Copper) Analysis: ",
                    analysis_heap_leach_fines_ok: "Fines content ({value}%) is suitable for maintaining heap permeability. ",
                    analysis_heap_leach_fines_high: "Fines content ({value}%) is high, which may risk reducing heap permeability and recovery. ",
                    analysis_heap_leach_d80: "The D80 crush size is {value} mm. ",
                    analysis_heap_leach_d80_coarse: "This is a coarse crush, which may lead to lower copper recovery. ",
                    analysis_heap_leach_d80_fine: "This is a fine crush, which may increase recovery but could risk heap stability and permeability. "
                },
                fa: {
                    title: "آنالیز دانه‌بندی مصالح", header_title: "آنالیز دانه‌بندی", lang_button: "English", export_word: "خروجی Word", export_excel: "خروجی Excel", export_pdf: "خروجی PDF",
                    material_selection_title: "۱. انتخاب نوع مصالح و استاندارد", crushed_rock: "سنگ شکن", concrete_aggregates: "بتن", soil_clay: "رس",
                    astm: "ASTM", iso: "ISO", aashto: "AASHTO", sieve_inputs_title: "۲. ورود اطلاعات سرندها", sieve_size: "اندازه سرند (µm)", retained_weight: "وزن باقی‌مانده (گرم)",
                    actions: "عملیات", add_sieve: "افزودن سرند", delete_button: "حذف", calculate_button: "محاسبه", results_title: "۳. نتایج آنالیز", cu: "ضریب یکنواختی (Cu):",
                    cc: "ضریب انحنا (Cc):", mean: "میانگین وزنی (μm):", std_dev: "انحراف معیار:", analysis_title: "تحلیل متنی", charts_title: "۴. نمودارها",
                    retained_75mm: "درصد بزرگتر از ۷۵ میلی متر:", retained_45mm: "درصد بزرگتر از ۴۵ میلی متر:",
                    alert_no_weight: "وزن کل نمی‌تواند صفر باشد. لطفاً وزن‌های باقی‌مانده را وارد کنید.", alert_no_calculation: "لطفاً ابتدا یک محاسبه انجام دهید.", generating: "در حال تولید...",
                    word_modal_title: "اطلاعات گزارش Word", word_modal_report_title: "عنوان گزارش", word_modal_report_desc: "توضیحات", word_modal_report_date: "تاریخ",
                    word_modal_cancel: "انصراف", word_modal_confirm: "تولید گزارش", pan: "سینی",
                    chart_title_passing: "منحنی تجمعی عبوری", chart_title_retained: "منحنی تجمعی باقی‌مانده", chart_title_histogram: "هیستوگرام (درصد باقی‌مانده)",
                    chart_xaxis_label: "اندازه سرند (µm) - مقیاس لگاریتمی", chart_yaxis_passing: "درصد عبوری (%)", chart_yaxis_retained: "درصد باقی‌مانده (%)", chart_yaxis_retained_hist: "درصد باقی‌مانده (%)",
                    chart_legend_passing: "عبوری تجمعی", chart_legend_retained: "باقی‌مانده تجمعی", chart_legend_retained_hist: "درصد باقی‌مانده", mean_label: "میانگین", std_dev_label: "انحراف معیار",
                    analysis_err_no_fines: "امکان تعیین درصد ریزدانه (بدون داده سرند ۷۵µm) وجود ندارد. طبقه‌بندی ممکن نیست.", analysis_err_no_coeffs: "داده‌های کافی برای طبقه‌بندی خاک وجود ندارد. مقادیر D10، D30 و D60 مورد نیاز است.",
                    analysis_err_no_split: "امکان تفکیک شن و ماسه (بدون داده سرند ۴.۷۵mm/۴۷۵۰µm) وجود ندارد. طبقه‌بندی ممکن نیست.",
                    analysis_title_uscs: "طبقه‌بندی خاک (USCS): ",
                    analysis_fine_grained: "ماده ریزدانه است (بیش از ۵۰٪ عبوری از سرند ۷۵µm). برای طبقه‌بندی کامل به حدود اتربرگ نیاز است.",
                    analysis_coarse_grained: "ماده درشت‌دانه است ({value}٪ مانده روی سرند ۷۵µm). ",
                    analysis_base_gravel: "بخش درشت‌دانه عمدتا شن ({value}٪) است. ",
                    analysis_base_sand: "بخش درشت‌دانه عمدتا ماسه ({value}٪) است. ",
                    analysis_fines_lt_5: "ریزدانه کمتر از ۵٪. ",
                    analysis_fines_gt_12: "ریزدانه بیشتر از ۱۲٪. ",
                    analysis_fines_borderline: "حالت مرزی (ریزدانه بین ۵ تا ۱۲٪). ",
                    analysis_gw: "طبقه‌بندی: GW (شن خوب دانه‌بندی شده).",
                    analysis_gp: "طبقه‌بندی: GP (شن بد دانه‌بندی شده).",
                    analysis_plasticity_gm_gc: "برای طبقه‌بندی به عنوان GM (شن لای‌دار) یا GC (شن رس‌دار) به آزمایش‌های خمیری بیشتری نیاز است.",
                    analysis_dual_symbol_gravel: "نیازمند نماد دوگانه است (مانند GW-GM، GP-GC).",
                    analysis_sw: "طبقه‌بندی: SW (ماسه خوب دانه‌بندی شده).",
                    analysis_sp: "طبقه‌بندی: SP (ماسه بد دانه‌بندی شده).",
                    analysis_plasticity_sm_sc: "برای طبقه‌بندی به عنوان SM (ماسه لای‌دار) یا SC (ماسه رس‌دار) به آزمایش‌های خمیری بیشتری نیاز است.",
                    analysis_dual_symbol_sand: "نیازمند نماد دوگانه است (مانند SW-SM، SP-SC).",
                    analysis_cu_value: "Cu = {value}. ",
                    analysis_cc_value: "Cc = {value}. ",
                    analysis_title_concrete: "\nتحلیل سنگدانه بتن: ",
                    analysis_fm_value: "مدول نرمی (FM) = {value}. ",
                    analysis_fm_good: "این مدول نرمی در محدوده استاندارد (۲.۳-۳.۱) برای سنگدانه ریز (ASTM C33) قرار دارد.",
                    analysis_fm_fine: "این نشان می‌دهد که ماسه ریزتر از حد معمول برای سنگدانه بتن است.",
                    analysis_fm_coarse: "این نشان می‌دهد که ماسه درشت‌تر از حد معمول برای سنگدانه بتن است.",
                    analysis_fm_na: "مدول نرمی قابل محاسبه نیست. از وجود سرندهای استاندارد اطمینان حاصل کنید.",
                    analysis_title_heap_leach: "\nتحلیل هیپ لیچینگ (مس اکسیدی): ",
                    analysis_heap_leach_fines_ok: "میزان ریزدانه ({value}٪) برای حفظ نفوذپذیری توده مناسب است. ",
                    analysis_heap_leach_fines_high: "میزان ریزدانه ({value}٪) بالا است که می‌تواند خطر کاهش نفوذپذیری و بازیابی را به همراه داشته باشد. ",
                    analysis_heap_leach_d80: "اندازه خردایش D80 برابر با {value} میلی‌متر است. ",
                    analysis_heap_leach_d80_coarse: "این خردایش درشت است که ممکن است منجر به بازیابی کمتر مس شود. ",
                    analysis_heap_leach_d80_fine: "این خردایش ریز است که ممکن است بازیابی را افزایش دهد اما می‌تواند پایداری و نفوذپذیری توده را به خطر اندازد. "
                }
            };

            let currentLang = 'fa';

            function setLanguage(lang) {
                currentLang = lang;
                document.documentElement.lang = lang;
                document.documentElement.dir = lang === 'fa' ? 'rtl' : 'ltr';
                document.querySelectorAll('[data-lang-key]').forEach(el => {
                    const key = el.getAttribute('data-lang-key');
                    if (translations[lang][key]) el.textContent = translations[lang][key];
                });
                if (lastCalculationData) {
                    const newAnalysisText = lastCalculationData.analysisKeys.map(key => translations[lang][key] || key).join(' ');
                    document.getElementById('text-analysis-output').textContent = newAnalysisText;
                    updateCharts();
                }
            }

            function toggleLanguage() {
                setLanguage(currentLang === 'fa' ? 'en' : 'fa');
            }
            setLanguage(currentLang);
        });
    </script>
</body>
</html>